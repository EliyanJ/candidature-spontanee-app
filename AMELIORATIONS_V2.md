# üöÄ Am√©liorations Version 2.0 - Application Candidatures Spontan√©es

## üìã Table des mati√®res

1. [Vue d'ensemble](#vue-densemble)
2. [Nouvelles fonctionnalit√©s](#nouvelles-fonctionnalit√©s)
3. [Architecture Backend](#architecture-backend)
4. [Nouvelles routes API](#nouvelles-routes-api)
5. [Guide de migration Frontend](#guide-de-migration-frontend)
6. [Tests et validation](#tests-et-validation)

---

## üéØ Vue d'ensemble

Cette version 2.0 apporte des am√©liorations majeures pour :
- ‚úÖ **√âviter la saturation** des entreprises avec un syst√®me de randomisation intelligent
- ‚úÖ **√âliminer les doublons** avec une blacklist par utilisateur
- ‚úÖ **Am√©liorer l'UX** avec des filtres avanc√©s et intuitifs
- ‚úÖ **Respecter l'API** avec gestion du rate limit et pagination

---

## üÜï Nouvelles fonctionnalit√©s

### 1. üé≤ Randomisation intelligente (√ó6)

**Probl√®me r√©solu :** Sans randomisation, tous les utilisateurs ciblent les 25 m√™mes entreprises.

**Solution :**
- L'utilisateur demande 20 entreprises
- Le syst√®me r√©cup√®re **120 entreprises** (√ó6)
- Randomisation Fisher-Yates pour distribution √©quitable
- Retour de 20 entreprises al√©atoires

**Impact :**
- Avant : 10 000 candidatures sur 25 entreprises (400/entreprise)
- Apr√®s : 10 000 candidatures sur 120 entreprises (~83/entreprise)

### 2. üö´ Blacklist par utilisateur

**Fonctionnement :**
- Chaque entreprise contact√©e est ajout√©e √† la blacklist de l'utilisateur
- Lors des recherches suivantes, ces entreprises sont automatiquement exclues
- Aucun doublon possible pour un m√™me utilisateur

**Avantages :**
- Pas de recontact d'entreprises d√©j√† sollicit√©es
- Exploration progressive de nouvelles opportunit√©s
- Respect des entreprises

### 3. üèôÔ∏è Gestion des arrondissements

**Villes support√©es :**
- **Paris** : 20 arrondissements (75001 ‚Üí 75020)
- **Lyon** : 9 arrondissements (69001 ‚Üí 69009)
- **Marseille** : 16 arrondissements (13001 ‚Üí 13016)

**Fonctionnement :**
```javascript
Input: "Paris"
‚Üí API: code_postal=75001,75002,...,75020

Input: "75008"
‚Üí API: code_postal=75008
```

**Correction orthographique :**
- "pari" ‚Üí Suggestion : "paris"
- Distance de Levenshtein (max 3 caract√®res)

### 4. üìä Secteurs d'activit√© organis√©s

**14 secteurs disponibles :**

| Secteur | Codes APE | Exemples |
|---------|-----------|----------|
| üíª Tech & Digital | 62.01Z, 62.02A, 63.11Z... | Programmation, Conseil IT |
| üè¢ Conseil & Services | 70.22Z, 71.12B, 78.10Z... | Conseil affaires, Recrutement |
| üìä Marketing & Com | 73.11Z, 73.20Z... | Publicit√©, √âtudes de march√© |
| üè™ Commerce | 47.91A, 46.90Z... | E-commerce, Gros |
| üè¶ Banque & Finance | 64.19Z, 66.12Z... | Banques, Courtage |
| üéì Education | 85.42Z, 85.59A... | Enseignement, Formation |
| üèóÔ∏è BTP | 41.10A, 43.21A... | Construction, Installation |
| üè† Immobilier | 68.31Z, 68.32A... | Agences, Administration |
| ... | ... | ... |

### 5. üë• Filtrage par taille d'entreprise

**4 cat√©gories :**

| Cat√©gorie | Effectifs | Codes API |
|-----------|-----------|-----------|
| TPE | 1-9 salari√©s | 01, 02, 03 |
| Petite entreprise | 10-49 salari√©s | 11, 12 |
| Moyenne entreprise | 50-249 salari√©s | 21, 22, 31 |
| Grande entreprise | 250+ salari√©s | 32, 41, 42, 51, 52, 53 |

**Exclusion automatique :**
- Entrepreneurs individuels (0 salari√©) exclus par d√©faut
- Param√®tre `est_entrepreneur_individuel=false`

---

## üèóÔ∏è Architecture Backend

### Nouveaux fichiers cr√©√©s

```
backend/
‚îú‚îÄ‚îÄ constants/
‚îÇ   ‚îú‚îÄ‚îÄ apeSectors.js        # 14 secteurs avec codes APE
‚îÇ   ‚îú‚îÄ‚îÄ cities.js            # Gestion arrondissements + villes
‚îÇ   ‚îî‚îÄ‚îÄ effectifs.js         # Tranches d'effectifs salari√©s
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ constantsController.js  # API pour exposer les constantes
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îî‚îÄ‚îÄ constants.js         # Routes /api/constants/*
‚îî‚îÄ‚îÄ db/
    ‚îî‚îÄ‚îÄ database.js          # + table blacklist + fonctions helper
```

### Fichiers modifi√©s

```
backend/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ sireneService.js     # Refactorisation compl√®te ‚≠ê
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îú‚îÄ‚îÄ companiesController.js   # Support blacklist + nouveaux filtres
‚îÇ   ‚îî‚îÄ‚îÄ campaignsController.js   # Ajout auto √† blacklist
‚îî‚îÄ‚îÄ server.js                # + route constants
```

### Table SQL ajout√©e

```sql
CREATE TABLE user_company_blacklist (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  company_siren TEXT NOT NULL,
  contacted_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, company_siren)
);

CREATE INDEX idx_blacklist_user ON user_company_blacklist(user_id);
```

---

## üîå Nouvelles routes API

### 1. `/api/constants/all` (GET)

R√©cup√®re toutes les constantes en une seule requ√™te.

**R√©ponse :**
```json
{
  "success": true,
  "data": {
    "apeSectors": [...],
    "effectifs": [...],
    "citiesWithArrondissements": {...},
    "mainCities": [...]
  }
}
```

### 2. `/api/constants/ape-sectors` (GET)

Liste des secteurs APE organis√©s.

**R√©ponse :**
```json
{
  "success": true,
  "sectors": [
    {
      "id": "tech_digital",
      "label": "üíª Tech & Digital",
      "icon": "üíª",
      "codes": [
        { "value": "62.01Z", "label": "Programmation informatique" },
        ...
      ]
    },
    ...
  ]
}
```

### 3. `/api/constants/effectifs` (GET)

Tranches d'effectifs disponibles.

**R√©ponse :**
```json
{
  "success": true,
  "tranches": [
    {
      "id": "tpe",
      "label": "TPE (1-9 salari√©s)",
      "codes": ["01", "02", "03"],
      "min": 1,
      "max": 9
    },
    ...
  ]
}
```

### 4. `/api/constants/resolve-location` (GET)

R√©soudre une ville ou code postal.

**Param√®tres :**
- `location` (string) : Ville ou code postal

**Exemples :**

```bash
GET /api/constants/resolve-location?location=Paris

{
  "success": true,
  "type": "ville_arrondissements",
  "ville": "Paris",
  "codePostaux": ["75001", "75002", ..., "75020"],
  "count": 20
}
```

```bash
GET /api/constants/resolve-location?location=75008

{
  "success": true,
  "type": "code_postal",
  "codePostaux": ["75008"],
  "count": 1
}
```

```bash
GET /api/constants/resolve-location?location=pari

{
  "success": false,
  "type": "ville_inconnue",
  "error": "Ville 'pari' non trouv√©e",
  "suggestions": ["paris"],
  "codePostaux": []
}
```

### 5. `/api/companies/search` (GET) - Mis √† jour

**Nouveaux param√®tres :**

| Param√®tre | Type | Description | Exemple |
|-----------|------|-------------|---------|
| `location` | string | Ville ou code postal unifi√© | `Paris`, `75008` |
| `tranche_effectif_salarie` | string | Codes effectifs (CSV) | `11,12,21` |
| `nature_juridique` | string | Code nature juridique | `5710` (SAS) |
| `categorie_entreprise` | string | PME, ETI, GE | `PME` |
| `userId` | string | ID utilisateur (blacklist) | `user123` |
| `nombre` | number | Nombre souhait√© | `20` |

**Exemple complet :**
```bash
GET /api/companies/search?
  location=Paris&
  codeApe=62.01Z&
  tranche_effectif_salarie=11,12,21&
  nombre=20&
  userId=user123
```

**R√©ponse :**
```json
{
  "success": true,
  "count": 20,
  "data": [
    {
      "siret": "12345678901234",
      "siren": "123456789",
      "nom": "ENTREPRISE EXEMPLE SAS",
      "adresse": "1 RUE DE LA PAIX",
      "code_postal": "75008",
      "ville": "PARIS",
      "code_ape": "62.01Z",
      "libelle_ape": "Programmation informatique",
      "effectif": "10 √† 19 salari√©s",
      "effectif_code": "11",
      "nature_juridique": "5710",
      ...
    },
    ...
  ]
}
```

### 6. `/api/campaigns/:id/start` (POST) - Mis √† jour

**Nouveau param√®tre body :**
```json
{
  "companyIds": [1, 2, 3, ...],
  "userId": "user123"  // ‚Üê Nouveau !
}
```

**Fonctionnement :**
1. Envoi des emails
2. Pour chaque entreprise contact√©e avec succ√®s :
   - R√©cup√©ration du SIREN
   - Ajout automatique √† la blacklist de l'utilisateur

---

## üé® Guide de migration Frontend

### √âtape 1 : R√©cup√©rer les constantes au chargement

```javascript
// Dans App.js ou SearchCompanies.js
import { useEffect, useState } from 'react';
import api from './services/api';

function SearchCompanies() {
  const [constants, setConstants] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function loadConstants() {
      try {
        const response = await api.get('/constants/all');
        setConstants(response.data.data);
      } catch (error) {
        console.error('Erreur chargement constantes:', error);
      } finally {
        setLoading(false);
      }
    }

    loadConstants();
  }, []);

  if (loading) return <div>Chargement...</div>;

  return (
    <div>
      {/* Formulaire de recherche */}
    </div>
  );
}
```

### √âtape 2 : Cr√©er le select pour les secteurs APE

```javascript
function SectorSelect({ value, onChange, sectors }) {
  return (
    <select value={value} onChange={(e) => onChange(e.target.value)}>
      <option value="">Tous les secteurs</option>
      {sectors.map(sector => (
        <optgroup key={sector.id} label={sector.label}>
          {sector.codes.map(code => (
            <option key={code.value} value={code.value}>
              {code.label}
            </option>
          ))}
        </optgroup>
      ))}
    </select>
  );
}

// Utilisation
<SectorSelect
  value={filters.codeApe}
  onChange={(val) => setFilters({...filters, codeApe: val})}
  sectors={constants.apeSectors}
/>
```

### √âtape 3 : Input de localisation avec validation

```javascript
function LocationInput({ value, onChange }) {
  const [suggestions, setSuggestions] = useState([]);
  const [validationError, setValidationError] = useState('');

  const handleBlur = async () => {
    if (!value) return;

    try {
      const response = await api.get(`/constants/resolve-location?location=${value}`);

      if (!response.data.success) {
        setValidationError(response.data.error);
        setSuggestions(response.data.suggestions || []);
      } else {
        setValidationError('');
        setSuggestions([]);
      }
    } catch (error) {
      console.error('Erreur validation localisation:', error);
    }
  };

  return (
    <div>
      <input
        type="text"
        value={value}
        onChange={(e) => onChange(e.target.value)}
        onBlur={handleBlur}
        placeholder="Ville ou code postal (ex: Paris, 75008)"
      />

      {validationError && (
        <div style={{ color: 'red' }}>
          {validationError}
          {suggestions.length > 0 && (
            <div>
              Suggestions : {suggestions.map(s => (
                <button key={s} onClick={() => onChange(s)}>
                  {s}
                </button>
              ))}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

### √âtape 4 : Select pour les effectifs

```javascript
function EffectifSelect({ value, onChange, tranches }) {
  return (
    <select value={value} onChange={(e) => onChange(e.target.value)}>
      <option value="">Toutes les tailles</option>
      {tranches.map(tranche => (
        <option key={tranche.id} value={tranche.codes.join(',')}>
          {tranche.label}
        </option>
      ))}
    </select>
  );
}

// Utilisation
<EffectifSelect
  value={filters.tranche_effectif_salarie}
  onChange={(val) => setFilters({...filters, tranche_effectif_salarie: val})}
  tranches={constants.effectifs}
/>
```

### √âtape 5 : Appel API de recherche avec userId

```javascript
async function searchCompanies() {
  const userId = localStorage.getItem('userId') || generateUserId();

  try {
    const params = {
      location: filters.location,
      codeApe: filters.codeApe,
      tranche_effectif_salarie: filters.tranche_effectif_salarie,
      nombre: 20,
      userId: userId  // ‚Üê Important !
    };

    const response = await api.get('/companies/search', { params });

    setCompanies(response.data.data);
  } catch (error) {
    console.error('Erreur recherche:', error);
  }
}

// G√©n√©rer un userId unique pour l'utilisateur
function generateUserId() {
  const id = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  localStorage.setItem('userId', id);
  return id;
}
```

### √âtape 6 : Lancer une campagne avec userId

```javascript
async function startCampaign(campaignId, companyIds) {
  const userId = localStorage.getItem('userId');

  try {
    await api.post(`/campaigns/${campaignId}/start`, {
      companyIds: companyIds,
      userId: userId  // ‚Üê Important !
    });

    console.log('Campagne lanc√©e avec succ√®s');
    // Les entreprises seront automatiquement ajout√©es √† la blacklist
  } catch (error) {
    console.error('Erreur lancement campagne:', error);
  }
}
```

---

## ‚úÖ Tests et validation

### Test 1 : V√©rifier la randomisation

```bash
# Terminal 1 (User A)
curl "http://localhost:3001/api/companies/search?location=Paris&codeApe=62.01Z&nombre=5&userId=userA"

# Terminal 2 (User B)
curl "http://localhost:3001/api/companies/search?location=Paris&codeApe=62.01Z&nombre=5&userId=userB"

# R√©sultat attendu : Les 2 listes doivent √™tre DIFF√âRENTES
```

### Test 2 : V√©rifier la blacklist

```bash
# 1. Recherche initiale
curl "http://localhost:3001/api/companies/search?location=Paris&codeApe=62.01Z&nombre=5&userId=test_user"
# Note: SIREN des entreprises retourn√©es

# 2. Simuler l'envoi d'emails
curl -X POST "http://localhost:3001/api/campaigns/1/start" \
  -H "Content-Type: application/json" \
  -d '{"companyIds": [1,2,3], "userId": "test_user"}'

# 3. Nouvelle recherche
curl "http://localhost:3001/api/companies/search?location=Paris&codeApe=62.01Z&nombre=5&userId=test_user"

# R√©sultat attendu : Les entreprises de l'√©tape 1 ne doivent PAS appara√Ætre
```

### Test 3 : V√©rifier la r√©solution de localisation

```bash
# Ville avec arrondissements
curl "http://localhost:3001/api/constants/resolve-location?location=Paris"
# ‚Üí 20 codes postaux

# Code postal unique
curl "http://localhost:3001/api/constants/resolve-location?location=75008"
# ‚Üí 1 code postal

# Ville inconnue
curl "http://localhost:3001/api/constants/resolve-location?location=pari"
# ‚Üí Suggestions: ["paris"]
```

### Test 4 : V√©rifier le rate limit

```bash
# Lancer une recherche qui n√©cessite 10 pages (250 entreprises)
time curl "http://localhost:3001/api/companies/search?location=Paris&codeApe=62.01Z&nombre=250&userId=test"

# Temps attendu : ~5-6 secondes (10 pages √ó 500ms + 9 d√©lais √ó 150ms)
# V√©rifier les logs : Aucun code 429
```

### Test 5 : V√©rifier les constantes

```bash
# R√©cup√©rer toutes les constantes
curl "http://localhost:3001/api/constants/all" | json_pp

# V√©rifier les secteurs APE
curl "http://localhost:3001/api/constants/ape-sectors" | json_pp

# V√©rifier les effectifs
curl "http://localhost:3001/api/constants/effectifs" | json_pp
```

---

## üìä Logs de d√©bogage

Le syst√®me affiche des logs d√©taill√©s pour suivre l'ex√©cution :

```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   üé≤ RANDOMISATION INTELLIGENTE ACTIV√âE      ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
üìä User demande      : 20 entreprises
üì¶ Pool √† r√©cup√©rer : 120 entreprises (√ó6)
‚è±Ô∏è  Temps estim√©     : ~4.2s
üë§ User ID          : user123 (blacklist activ√©e)

üìÑ R√©cup√©ration de 5 pages (25 entreprises/page)...
  ‚úì Page 1/5 : 25 entreprises r√©cup√©r√©es
  ‚úì Page 2/5 : 25 entreprises r√©cup√©r√©es
  ‚úì Page 3/5 : 25 entreprises r√©cup√©r√©es
  ‚úì Page 4/5 : 25 entreprises r√©cup√©r√©es
  ‚úì Page 5/5 : 20 entreprises r√©cup√©r√©es
  ‚ÑπÔ∏è  120 entreprises r√©cup√©r√©es (objectif atteint)
‚úÖ 120 entreprises r√©cup√©r√©es en 4.1s
üö´ 15 entreprises d√©j√† contact√©es exclues
   Reste : 105 entreprises disponibles
üé≤ Pool randomis√© avec Fisher-Yates
üéØ Retour de 20 entreprises al√©atoires
‚è±Ô∏è  Temps total : 4.1s
```

---

## üöÄ Prochaines √©tapes

### Pour le frontend (TODO)

1. **Cr√©er le nouveau formulaire de recherche**
   - Select secteurs APE organis√©s
   - Input localisation avec validation
   - Select taille d'entreprise
   - Syst√®me de g√©n√©ration/stockage userId

2. **Afficher les entreprises**
   - Indicateur "Randomis√©es" dans l'UI
   - Badge "Nouvelle entreprise" vs "D√©j√† vue"
   - Temps de recherche affich√©

3. **Dashboard blacklist**
   - Nombre d'entreprises contact√©es
   - Liste des entreprises blacklist√©es
   - Option "Retirer de la blacklist"

### Am√©liorations futures (optionnel)

- üîç Recherche avanc√©e multi-crit√®res (AND/OR)
- üìà Statistiques de distribution des candidatures
- üó∫Ô∏è Carte interactive des entreprises
- üìß D√©tection automatique de r√©ponses positives
- ü§ñ Suggestion IA de secteurs pertinents

---

## üìû Support

Pour toute question sur ces am√©liorations :
1. Consulter les logs du backend (terminal)
2. Tester les routes API avec curl/Postman
3. V√©rifier la table `user_company_blacklist` dans SQLite

**Bon courage pour l'int√©gration frontend ! üöÄ**
